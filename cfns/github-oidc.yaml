Parameters:
  GitHubOrg:
    Description: Name of the GitHub organization/user
    Type: String
  RepositoryName:
    Description: Name of the repository
    Type: String
  OIDCProviderArn:
    Description: Arn of OIDC Provider (leave empty, if need to be created)
    Default: ""
    Type: String
  OIDCAudience:
    Description: Audience(aud) field(claim) in the final JWT issued by Github OIDC server
    Default: "sts.amazonaws.com"
    Type: String

Conditions:
  CreateOIDCProvider: !Equals
  - !Ref OIDCProviderArn
  - ""

Resources:
  Role:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Action: sts:AssumeRoleWithWebIdentity
          Principal:
            Federated: !If 
            - CreateOIDCProvider
            - GithubOidc
            - !Ref OIDCProviderArn
          Condition: 
            StringEquals:
              token.actions.githubusercontent.com.aud: !Ref OIDCAudience
            StringLike:
              token.actions.githubusercontent.com.sub: !Sub repo:${GitHubOrg}/${RepositoryName}:*
  GithubOidc:
    Type: AWS::IAM::OIDCProvider
    Condition: CreateOIDCProvider
    Properties:
      Url: https://token.actions.githubusercontent.com
      ClientIdList:
        - sts.amazonaws.com
      ThumbprintList:
        - ffffffffffffffffffffffffffffffffffffffff

Outputs:
  Role:
    Value: !GetAtt Role.Arn